name: Stock ATH Decline Alert

on:
  schedule:
    - cron: '0 14 * * *'   # 7:30 PM IST
  workflow_dispatch:
    inputs:
      stocks:
        description: 'Extra Yahoo symbols (comma-separated)'
        required: false

env:
  BASE_STOCKS: >-
    NIFTYBEES.NS,JUNIORBEES.NS,NIFTY100BEES.NS,BANKBEES.NS,ITBEES.NS,
    MIDCAPBEES.NS,SML250BEES.NS,FMCGBEES.NS,PHARMABEES.NS,AUTOBEES.NS,
    METALBEES.NS,ENERGYBEES.NS,PSUBNKBEES.NS,REALTYBEES.NS,INFRABEES.NS,
    LOWVOLBEES.NS,ALPHABEES.NS,QUALITYBEES.NS,MOMENTUMBEES.NS,VALUEBEES.NS,
    ^BSESN,^BSE100,^BSE200,^BSE500,^BSEMDCP,^BSESMLCP,^BSEBANK

jobs:
  ath-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install yfinance pandas

      - name: Build STOCKS list (append + deduplicate)
        run: |
          INPUT_STOCKS="${{ github.event.inputs.stocks }}"

          if [ -n "$INPUT_STOCKS" ]; then
            ALL_STOCKS="${BASE_STOCKS},$INPUT_STOCKS"
          else
            ALL_STOCKS="${BASE_STOCKS}"
          fi

          # Remove spaces, split, deduplicate, rejoin
          FINAL_STOCKS=$(echo "$ALL_STOCKS" \
            | tr -d ' ' \
            | tr ',' '\n' \
            | sort -u \
            | paste -sd ',' -)

          echo "STOCKS=$FINAL_STOCKS" >> $GITHUB_ENV

          echo "Final STOCKS list:"
          echo "$FINAL_STOCKS" | tr ',' '\n'

      - name: Check ATH decline and send email
        env:
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
          EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
        run: |
          python .github/workflows/scripts/ath_alert.py
